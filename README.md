# Феррум — ERP-система производственного планирования

**URL:** https://ferrum-tau.vercel.app
**Стек:** React + Vite + Tailwind CSS + Firebase (Firestore) + Supabase (Storage, Edge Functions)

ERP-система для управления производством на предприятиях Химмаш и РТИ. Охватывает полный цикл: от создания заказа до отгрузки, включая снабжение, управление персоналом и аналитику.

---

## Разделы системы

### 1. Планирование (`/`)

Главный раздел. Здесь создаются и управляются **заказы** с привязкой к клиентам и срокам.

**Возможности:**
- Создание заказов с клиентом, номером и дедлайном
- Добавление товаров в заказ (вручную или из шаблонов-пресетов)
- Настройка операций для каждого товара (последовательность, ресурсы, время)
- Загрузка PDF-чертежей (хранятся в Supabase Storage)
- Перенос готовых заказов в отгрузку
- Восстановление товаров из архива

**Компоненты:** `PlanningTab`, `OrderCard`, `ProductCard`, `OperationRow`, `NewOrderModal`, `AddProductModal`, `DrawingsSection`

### 2. Товары (`/products`)

Каталог товаров с операциями. Доступен только администраторам.

**Возможности:**
- CRUD товаров и их операций
- Шаблоны операций (пресеты) для быстрого добавления
- Назначение ресурсов на операции
- Копирование операций между товарами

### 3. Отгрузка (`/shipping`)

Управление отгрузкой готовых заказов.

**Возможности:**
- Список заказов, готовых к отгрузке
- Пометка "Отгрузка сегодня" (создает алерт в шапке)
- Завершение отгрузки (заказ уходит в архив)
- Возврат из отгрузки в производство

**Доступ:** Администраторы, мастер, технолог, менеджер

### 4. Снабжение (`/supply`)

Полноценный workflow закупок с цепочкой согласований и прикреплением счетов.

**Workflow заявки:**
```
Создание → Снабженец (счёт) → Технолог → Нач. цеха → Директор → Веста (оплата) → Доставка → Завершение
```

**Статусы:**
| Статус | Ответственный | Дедлайн |
|--------|---------------|---------|
| `with_supplier` | Снабженец | 24ч |
| `invoice_attached` | Снабженец | 4ч |
| `pending_tech_approval` | Технолог | 4ч |
| `pending_shop_approval` | Начальник цеха | 4ч |
| `pending_director_approval` | Директор | 4ч |
| `pending_payment` | Веста | 2ч |
| `paid` | Снабженец | 8ч |
| `awaiting_delivery` | — | по дате |
| `delivered` | — | — |
| `rejected` | Снабженец | 24ч |

**Возможности:**
- Создание заявки с позициями, заказами, комментарием
- Редактирование заявки создателем (до одобрения директором)
- Прикрепление нескольких счетов (PDF, JPG, PNG)
- Предпросмотр счетов в модалке
- Согласование по цепочке ролей
- Отклонение с указанием причины (возврат к технологу или снабженцу)
- Назначение срока доставки, подтверждение доставки
- Фильтрация по цеху (Химмаш / РТИ), статусу, поиск
- Дедлайны с визуальными алертами (просрочка)
- Telegram-уведомления на каждом этапе

**Доступ:** Все роли

### 5. Цех — Персонал (`/resources`)

Управление сотрудниками, графиками и КТУ.

**Возможности:**
- Список сотрудников с должностями и датами приёма
- Графики работы с возможностью переопределения (отпуск, больничный)
- КТУ — коэффициент трудового участия (ежедневный)
- Учёт нарушений ТБ (техника безопасности)
- Зарплатная матрица с историей ставок
- Увольнение / удаление сотрудников

**Доступ:** Администраторы, технолог, Веста

### 6. Ганта (`/gantt`)

Диаграмма Ганта для визуализации загрузки производства.

**Возможности:**
- Календарная шкала с отображением заказов и товаров
- Тепловая карта загрузки по дням
- Визуализация операций и их длительности

**Доступ:** Администраторы, технолог, мастер

### 7. Отчёты (`/reports`)

Аналитика и отчётность по производству.

**Подразделы:**
- **КТУ мастера** — эффективность по дням
- **Зарплата** — расчёт ЗП по матрице ставок
- **Архив заказов** — просмотр завершённых заказов по периодам
- **Настройки ресурсов** — конфигурация параметров сотрудников

**Доступ:** Только администраторы

### 8. Режим Цеха (WorkshopMode)

Отдельный интерфейс для мастеров на производстве. Доступен по кнопке в шапке.

**Возможности:**
- Отметка начала/окончания рабочего дня
- Управление ежедневными задачами
- Упрощённый интерфейс для цехового терминала

---

## Роли и доступ

| Роль | Ключ | Доступ |
|------|------|--------|
| Технолог | `technologist` | Планирование, товары, отгрузка, снабжение (создание, согласование), цех, Ганта |
| Снабженец | `supplier` | Снабжение (счета, доставка) |
| Начальник цеха | `shopManager` | Всё (администратор) |
| Директор | `director` | Всё (администратор) |
| Веста | `vesta` | Полный доступ: все разделы включая товары, отчёты, снабжение |
| Мастер | `master` | Планирование, отгрузка, снабжение, Ганта, режим цеха |

**Администраторы** (`director`, `shopManager`) — полный доступ ко всем разделам, включая товары и отчёты.

---

## Технический стек

| Компонент | Технология | Назначение |
|-----------|------------|------------|
| Frontend | React 18 + Vite | SPA-приложение |
| Стили | Tailwind CSS 3 | Утилитарный CSS |
| Роутинг | React Router 7 | Клиентская навигация |
| База данных | Firebase Firestore | Хранение данных, realtime |
| Файловое хранилище | Supabase Storage | PDF чертежей и счетов |
| Уведомления | Supabase Edge Functions → Telegram | Push ролям |
| Формы | React Hook Form + Zod | Валидация |
| Иконки | Lucide React | Иконки интерфейса |
| Тосты | React Hot Toast | Уведомления пользователю |
| PWA | vite-plugin-pwa | Мобильная поддержка |
| Деплой | Vercel (auto-deploy из main) | Хостинг |

## Структура проекта

```
src/
  App.jsx                     # Роутинг и инициализация
  firebase.js                 # Подключение Firebase
  components/
    Header.jsx                # Навигация, алерты
    RoleSelectionModal.jsx    # Авторизация по ролям
    WorkshopMode.jsx          # Режим цеха
    PlanningTab.jsx           # Планирование
    ProductsTab.jsx           # Каталог товаров
    ShippingTab.jsx           # Отгрузка
    ResourcesTab.jsx          # Персонал
    GanttTab.jsx              # Диаграмма Ганта
    supply/
      SupplyTab.jsx           # Главная снабжения
      SupplyRequestCard.jsx   # Карточка заявки
      CreateRequestModal.jsx  # Создание/редактирование
      RequestDetailsModal.jsx # Детали + действия
      DeliveryDateModal.jsx   # Назначение доставки
    reports/
      ReportsTab.jsx          # Навигация отчётов
      MasterEfficiencyView.jsx # КТУ
      SalaryView.jsx          # Зарплата
      CombinedArchiveView.jsx # Архив заказов
  hooks/
    useProductionData.js      # Главный хук данных (20+ действий)
    useSupplyRequests.js      # Данные снабжения (13 действий)
    useGanttData.js           # Данные для Ганта
    useOrders.js              # Обёртка для заказов
    useProducts.js            # Обёртка для товаров
    useResources.js           # Обёртка для ресурсов
    useReports.js             # Обёртка для отчётов
  utils/
    supplyRoles.js            # Роли, статусы, права, дедлайны
    helpers.js                # Даты, цвета, часы работы
    constants.js              # Типы операций, статусы заказов
    presets.js                # Шаблоны товаров (6 пресетов)
    supabaseStorage.js        # Загрузка/удаление файлов
    telegramNotify.js         # Telegram-уведомления
    toast.js                  # Система тостов
```

## Firebase коллекции

| Коллекция | Содержимое |
|-----------|------------|
| `orders` | Заказы: клиент, статус, товары, чертежи, дедлайны |
| `products` | Каталог товаров: название, операции |
| `resources` | Сотрудники: график, КТУ, ТБ, зарплата |
| `reports` | Отчёты и аналитика |
| `supplyRequests` | Заявки снабжения: позиции, счета, согласования, история |

## Переменные окружения (.env)

```env
# Firebase
VITE_FIREBASE_API_KEY=
VITE_FIREBASE_AUTH_DOMAIN=
VITE_FIREBASE_PROJECT_ID=
VITE_FIREBASE_STORAGE_BUCKET=
VITE_FIREBASE_MESSAGING_SENDER_ID=
VITE_FIREBASE_APP_ID=
VITE_FIREBASE_MEASUREMENT_ID=

# Supabase (хранилище файлов + Edge Functions)
VITE_SUPABASE_URL=
VITE_SUPABASE_ANON_KEY=
```

## Запуск

```bash
npm install
npm run dev        # Режим разработки
npm run build      # Сборка
npm run lint:fix   # Линтинг
npm run test       # Тесты
```

**Деплой:** автоматический при пуше в `main` через Vercel.

---

## Система уведомлений

Telegram-уведомления отправляются через Supabase Edge Function `telegram-notify` при каждом изменении статуса заявки снабжения. Уведомления приходят соответствующей роли (снабженцу, технологу, директору и т.д.).

**Алерты в шапке:**
- Срочная отгрузка (заказы с пометкой "сегодня")
- КТУ не заполнен (после 17:30 для мастеров)
- Снабжение: доставка завтра/сегодня

---

## План развития

### Ближайшие задачи
- Авторизация через Firebase Auth (вместо паролей в коде)
- Уведомления о просроченных дедлайнах снабжения в Telegram
- Фильтрация заявок снабжения по создателю
- Отображение общей суммы по счетам в заявке

### Среднесрочные
- Мобильное приложение (PWA уже настроен)
- Дашборд руководителя с ключевыми метриками
- Экспорт отчётов в Excel/PDF
- История изменений заказов (аудит-лог)
- Интеграция с 1С для обмена данными

### Долгосрочные
- Автоматическое планирование загрузки ресурсов (алгоритм)
- Прогнозирование сроков на основе исторических данных
- Модуль складского учёта
- Модуль контроля качества (ОТК)
- Мультиязычность (если потребуется)
