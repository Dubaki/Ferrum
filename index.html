<script>
        // ===== ИНИЦИАЛИЗАЦИЯ TELEGRAM WEB APP =====
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.MainButton.setText('Отправка...'); // Текст для кнопки загрузки

        // ===== КОНФИГУРАЦИЯ N8N (УБЕДИТЕСЬ, ЧТО ЗДЕСЬ TEST URL ДЛЯ ТЕСТА) =====
        const N8N_CONFIG = {
            webhookUrl: 'https://abidmumetoy.beget.app/webhook-test/ferrum-order', // <-- УБЕДИТЕСЬ, ЧТО ЗДЕСЬ TEST URL
        };

        // ===== ПЕРЕМЕННЫЕ СОСТОЯНИЯ =====
        let selectedBurnerPower = '';
        let selectedElectricPower = '';
        let quantities = {
            zazornik: 0,
            washer: 0,
            bracket: 0
        };

        // ===== ФУНКЦИИ НАВИГАЦИИ =====
        function showScreen(screenId) {
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('ovenScreen').classList.add('hidden');
            document.getElementById('mountingScreen').classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
        }

        function updatePowerOptions() {
            const powerType = document.getElementById('powerType').value;
            document.getElementById('gasOptions').classList.add('hidden');
            document.getElementById('electricOptions').classList.add('hidden');

            if (powerType === 'gas') {
                document.getElementById('gasOptions').classList.remove('hidden');
            } else if (powerType === 'electric') {
                document.getElementById('electricOptions').classList.remove('hidden');
            }
        }

        function selectPower(power) {
            selectedBurnerPower = power;
            document.querySelectorAll('.power-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if(event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
        }

        function selectElectricPower(power) {
            selectedElectricPower = power;
            document.querySelectorAll('.power-option').forEach(btn => {
                btn.classList.remove('active');
            });
            if(event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
        }

        function changeQty(item, delta) {
            quantities[item] = Math.max(0, quantities[item] + delta);
            document.getElementById('qty-' + item).textContent = quantities[item];
        }

        // ===== ФУНКЦИЯ POPUP УСПЕХА (НЕ ИСПОЛЬЗУЕТСЯ В ЭТОМ ТЕСТЕ) =====
        function showSuccessMessage() {
            // ... (код остался прежним) ...
        }

        // ===== ФУНКЦИЯ ОТПРАВКИ В N8N (ДИАГНОСТИЧЕСКАЯ ВЕРСИЯ) =====
        async function sendToN8N(orderData) {
            // Блокируем кнопки
            document.getElementById('submitOvenBtn').disabled = true;
            document.getElementById('submitMountingBtn').disabled = true;

            try {
                // Подготавливаем данные для отправки (остается для лога)
                const payload = {
                    orderType: orderData.type,
                    user: {
                        id: tg.initDataUnsafe?.user?.id,
                        username: tg.initDataUnsafe?.user?.username,
                        firstName: tg.initDataUnsafe?.user?.first_name,
                        lastName: tg.initDataUnsafe?.user?.last_name,
                        languageCode: tg.initDataUnsafe?.user?.language_code,
                    },
                    order: orderData,
                    meta: {
                        timestamp: new Date().toISOString(),
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                        platform: tg.platform,
                        version: tg.version,
                        chatId: tg.initDataUnsafe?.chat?.id,
                    },
                    auth: {
                        initData: tg.initData,
                    }
                };

                console.log('Подготовлены данные:', payload);
                console.log('Попытка отправки на URL:', N8N_CONFIG.webhookUrl); // Лог URL

                // ===== ДИАГНОСТИКА: Показываем URL перед "отправкой" =====
                // Проверяем, поддерживает ли клиент showAlert
                if (tg.showAlert) {
                   tg.showAlert(`Сейчас я попробую отправить данные на:\n\n${N8N_CONFIG.webhookUrl}`);
                } else {
                   // Если showAlert не поддерживается, выводим в консоль и закрываем
                   console.warn("showAlert не поддерживается. URL для отправки:", N8N_CONFIG.webhookUrl);
                   alert(`URL для отправки (showAlert не поддерживается):\n${N8N_CONFIG.webhookUrl}`); // Обычный alert как запасной вариант
                }
                // =======================================================

                // // Отправляем POST запрос в n8n - ЗАКОММЕНТИРОВАНО ДЛЯ ТЕСТА
                // const response = await fetch(N8N_CONFIG.webhookUrl, {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify(payload)
                // });
                //
                // if (!response.ok) {
                //     const errorText = await response.text();
                //     throw new Error(`HTTP ошибка! Статус: ${response.status}. ${errorText}`);
                // }
                // const result = await response.json();
                // console.log('Ответ от n8n:', result);
                //
                // showSuccessMessage();
                // setTimeout(() => { if (tg.close) tg.close(); }, 2000);
                // return { success: true, data: result };

                // ===== ПРОСТО ЗАКРЫВАЕМ ДЛЯ ТЕСТА =====
                // Даем немного времени на показ showAlert перед закрытием
                setTimeout(() => {
                    if (tg.close) {
                        tg.close();
                    } else {
                        console.log("tg.close не доступен.");
                    }
                }, 1000); // Закрываем через 1 секунду
                // ======================================


            } catch (error) {
                // Этот блок не должен сработать, т.к. fetch закомментирован
                console.error('Ошибка в блоке try (не должна возникнуть при диагностике):', error);

                 // Разблокируем кнопки в случае непредвиденной ошибки
                 document.getElementById('submitOvenBtn').disabled = false;
                 document.getElementById('submitMountingBtn').disabled = false;

                // Попытаемся показать ошибку через showAlert, если он доступен
                if (tg.showAlert) {
                   tg.showAlert(`Произошла неожиданная ошибка:\n\n${error.message}`);
                } else {
                   console.error("showAlert не поддерживается. Ошибка:", error.message);
                   alert(`Ошибка (showAlert не поддерживается):\n${error.message}`);
                }

                return { success: false, error: error.message };
            }
        }

        // ===== ФУНКЦИЯ ОТПРАВКИ ЗАКАЗА ПЕЧИ (ОСТАЛАСЬ ПРЕЖНЕЙ) =====
        function submitOvenOrder() {
            const powerType = document.getElementById('powerType').value;
            const ovenType = document.getElementById('ovenType').value;
            const width = document.getElementById('width').value;
            const depth = document.getElementById('depth').value;
            const height = document.getElementById('height').value;

            // Валидация (осталась прежней)
            if (!powerType) { tg.showAlert('⚠️ Выберите тип питания'); return; }
            if (!ovenType) { tg.showAlert('⚠️ Выберите тип печи (Тупиковая/Сквозная)'); return; }
            if (!width || !depth || !height) { tg.showAlert('⚠️ Укажите все размеры печи (Глубина, Ширина, Высота)'); return; }
            // ... (остальная валидация для gas/electric) ...
             if (powerType === 'gas') {
                 const burnersInput = document.getElementById('burners');
                 const burners = burnersInput ? burnersInput.value : null;
                 if (!burners) {
                     tg.showAlert('⚠️ Укажите количество горелок');
                     return;
                 }
                 if (!selectedBurnerPower) {
                     tg.showAlert('⚠️ Выберите мощность горелок');
                     return;
                 }
             }

             if (powerType === 'electric' && !selectedElectricPower) {
                 tg.showAlert('⚠️ Выберите мощность ТЭНов');
                 return;
             }


            // Формируем данные заказа (остались прежними)
            const orderData = {
                type: 'oven',
                category: 'Печи полимеризации',
                ovenType: ovenType,
                ovenTypeLabel: ovenType === 'dead-end' ? 'Тупиковая' : 'Сквозная',
                powerType: powerType,
                powerTypeLabel: powerType === 'gas' ? 'Газовая' : 'Электрическая',
                 ...(powerType === 'gas' && {
                     burners: parseInt(document.getElementById('burners').value), // Убедитесь что burners существует
                     burnerPower: selectedBurnerPower + ' кВт',
                     totalPower: (parseInt(document.getElementById('burners').value) * parseFloat(selectedBurnerPower)).toFixed(1) + ' кВт'
                 }),
                 ...(powerType === 'electric' && {
                     electricPower: selectedElectricPower + ' кВт',
                     tens: selectedElectricPower === '30' ? '10 ТЭНов × 3 кВт' : '15 ТЭНов × 3 кВт'
                 }),
                dimensions: {
                    width: parseInt(width),
                    depth: parseInt(depth),
                    height: parseInt(height),
                    formatted: `${depth}(Г) × ${width}(Ш) × ${height}(В) мм`
                },
                timestamp: new Date().toISOString()
            };

            // "Отправляем" (на самом деле покажем URL)
            sendToN8N(orderData);
        }

        // ===== ФУНКЦИЯ ОТПРАВКИ ЗАКАЗА МОНТАЖА (ОСТАЛАСЬ ПРЕЖНЕЙ) =====
        function submitMountingOrder() {
            const hasItems = quantities.zazornik > 0 || quantities.washer > 0 || quantities.bracket > 0;
            if (!hasItems) { tg.showAlert('⚠️ Выберите хотя бы одно изделие'); return; }
            const orderData = {
                type: 'mounting',
                category: 'Монтажные приспособления',
                items: [ /* ... ваш код ... */ ].filter(item => item.quantity > 0),
                totalQuantity: quantities.zazornik + quantities.washer + quantities.bracket,
                timestamp: new Date().toISOString()
            };
            sendToN8N(orderData);
        }

        // ===== ФУНКЦИЯ ДЛЯ ТЕСТИРОВАНИЯ (ОСТАЛАСЬ ПРЕЖНЕЙ) =====
        function testN8NConnection() {
            // ... (ваш код) ...
        }

        // ===== ОБРАБОТЧИКИ СОБЫТИЙ (ОСТАЛИСЬ ПРЕЖНИМИ) =====
        document.addEventListener('DOMContentLoaded', function() {
            // ... (ваш код) ...

             // Обработчик для кнопки отправки заказа печи
             document.getElementById('submitOvenBtn').addEventListener('click', submitOvenOrder);

             // Обработчик для кнопки отправки заказа монтажа
             document.getElementById('submitMountingBtn').addEventListener('click', submitMountingOrder);


            console.log('✅ Ferrum App загружен (ДИАГНОСТИЧЕСКАЯ ВЕРСИЯ)');
            console.log('Текущий n8n Webhook URL:', N8N_CONFIG.webhookUrl);
            console.log('Пользователь:', tg.initDataUnsafe?.user);
        });
    </script>
